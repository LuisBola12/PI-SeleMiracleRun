--- Funciones del Sistema

--- Funcion para calcular el monto total de deducciones voluntarias por empleado en determinado proyecto
CREATE FUNCTION calcularTotalDeduccionesVoluntariasDeEmpleado (
				@email VARCHAR(50),
				@proyecto VARCHAR(50)
) 
RETURNS FLOAT
AS
BEGIN
	DECLARE @totalVoluntaryDeductions float;
	select @totalVoluntaryDeductions = SUM(DV.Costo)
	from Usuarios U
	join Empleado E on U.Email = E.Email
		join EmpleadoAplicaDeduccionesVolundarias EA on E.Cedula = EA.CedulaEmpleado
			join DeduccionesVoluntarias DV on	EA.NombreDeduccion = DV.Nombre and
												EA.NombreProyecto = DV.NombreProyecto		
				join Proyecto P on DV.NombreProyecto = P.Nombre
	where U.Email = @email and P.Nombre = @proyecto
	group by E.Cedula;

	RETURN @totalVoluntaryDeductions;
END;

--- Funcion para calcular el monto total de beneficios por empleado en determinado proyecto
CREATE FUNCTION calcularTotalBeneficiosDeEmpleado (
				@email VARCHAR(50),
				@proyecto VARCHAR(50)
) 
RETURNS FLOAT
AS
BEGIN
	DECLARE @totalBenefits float;
	select @totalBenefits = SUM(B.CostoActual)
	from Usuarios U
	join Empleado E on U.Email = E.Email
		join EmpleadoGozaBeneficios EG on E.Cedula = EG.CedulaEmpleado
			join Beneficios B on	EG.NombreBeneficio = B.Nombre and
									EG.NombreProyecto = B.NombreProyecto		
				join Proyecto P on B.NombreProyecto = P.Nombre
	where U.Email = @email and P.Nombre = @proyecto
	group by E.Cedula;

	RETURN @totalBenefits;
END;

Create Procedure DeleteAnEmployeeFromAProject @Cedula varchar(15), @Proyecto varchar(50)
AS
    Declare @NumeroDeBeneficios int;
    Select @NumeroDeBeneficios = Count() from EmpleadoGozaBeneficios 
    where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    If(@NumeroDeBeneficios > 0)
    Begin
        Delete from EmpleadoGozaBeneficios where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    End
    Else
        Begin
            Print 'This Employee doesnt have benefits'
        End

    Declare @NumeroDeDeduccionesVoluntarias int;
    Select @NumeroDeDeduccionesVoluntarias = Count() from EmpleadoAplicaDeduccionesVolundarias 
    where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    If(@NumeroDeDeduccionesVoluntarias > 0)
    Begin
        Delete from EmpleadoAplicaDeduccionesVolundarias where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    End
    Else
        Begin
            Print 'This Employee doesnt have Voluntary Deductions'
        End
    Delete from EmpleadoYContratoSeAsocianAProyecto where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;