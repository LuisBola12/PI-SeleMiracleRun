



Create Procedure DeleteAnEmployeeFromAProject @Cedula varchar(15), @Proyecto varchar(50)
AS
    Declare @NumeroDeBeneficios int;
    Select @NumeroDeBeneficios = Count() from EmpleadoGozaBeneficios 
    where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    If(@NumeroDeBeneficios > 0)
    Begin
        Delete from EmpleadoGozaBeneficios where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    End
    Else
        Begin
            Print 'This Employee doesnt have benefits'
        End

    Declare @NumeroDeDeduccionesVoluntarias int;
    Select @NumeroDeDeduccionesVoluntarias = Count() from EmpleadoAplicaDeduccionesVolundarias 
    where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    If(@NumeroDeDeduccionesVoluntarias > 0)
    Begin
        Delete from EmpleadoAplicaDeduccionesVolundarias where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;
    End
    Else
        Begin
            Print 'This Employee doesnt have Voluntary Deductions'
        End
    Delete from EmpleadoYContratoSeAsocianAProyecto where CedulaEmpleado = @Cedula and NombreProyecto = @Proyecto;



CREATE PROCEDURE ObtenerBeneficiosEmpleado(
				@Email VARCHAR(50),
				@Proyecto VARCHAR(50)
)
AS
BEGIN
	SELECT P.CedulaEmpleador, B.Nombre, P.Nombre, B.CostoActual
	FROM Usuarios U
	JOIN Empleado E ON U.Email = E.Email
		JOIN BeneficioElegido BE ON E.Cedula = BE.CedulaEmpleado
			JOIN Beneficios B ON	BE.NombreBeneficio = B.Nombre and
												BE.NombreProyecto = B.NombreProyecto		
				JOIN Proyecto P ON B.NombreProyecto = P.Nombre
	where U.Email = @Email AND P.Nombre = @Proyecto AND BE.FechaFin > GETDATE()
END;

CREATE PROCEDURE calcularTotalBeneficiosDeEmpleado (
				@Email VARCHAR(50),
				@Proyecto VARCHAR(50),
				@ConsecutivoPlanilla int,
				@ConsecutivoPago int
) 
AS
BEGIN
	DECLARE @Resultados TABLE(CedulaEmpleador VARCHAR(15),NombreBeneficio VARCHAR(50), NombreProyecto VARCHAR(50), CostoBeneficio real)
	DECLARE @CedulaEmpleador VARCHAR(15), @NombreBeneficio VARCHAR(50), @NombreProyecto VARCHAR(50), @CostoBeneficio real
	INSERT INTO @Resultados EXEC ObtenerBeneficiosEmpleado @Email = @Email, @Proyecto = @Proyecto

	DECLARE cursor__ CURSOR FOR
	SELECT R.CedulaEmpleador, R.NombreBeneficio, R.NombreProyecto, R.CostoBeneficio
	FROM @Resultados R;
	OPEN cursor__

	FETCH NEXT FROM cursor__ INTO @CedulaEmpleador , @NombreBeneficio , @NombreProyecto , @CostoBeneficio
	WHILE @@FETCH_STATUS = 0 
		BEGIN
			INSERT INTO PagoContieneBeneficios(ConsecutivoPlanilla, CedulaEmpleador, ConsecutivoPago, NombreBeneficio, NombreProyecto, MontoBeneficio)
			VALUES (@ConsecutivoPlanilla, @CedulaEmpleador, @ConsecutivoPago, @NombreBeneficio, @NombreProyecto, @CostoBeneficio)
		
			FETCH NEXT FROM cursor__ INTO @CedulaEmpleador , @NombreBeneficio , @NombreProyecto , @CostoBeneficio
		END;

	SELECT SUM(R.CostoBeneficio) CostoDeduccion
	FROM @Resultados R

END;